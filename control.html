<html>
    <head>
        <link rel="shortcut icon" href="/favicon.ico?v=2" type="image/x-icon">
        <title>waves timer control panel</title>
        <script src="jquery.min.js"></script>
        <link rel="stylesheet" href="bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="stylesheet.css" media="screen"/>
    </head>
    <body>
        <!-- Status Section -->
        <div class="status-container">
            <div class="row">
                <div class="col-xs-12 text-center">
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">Status:</span>
                            <span id="status">stopwatch off</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Computer Time:</span>
                            <span id="timer"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="helptext col-xs-12 text-center">
                <p id="demo"></p>
                <script>
                    document.getElementById("demo").innerHTML = "" + window.location.href;
                </script>
                waves timer <p style="color:red;"><b>CONTROL PANEL</b></p><br />
                &copy; <script>document.write(new Date().getFullYear())</script> 
                <a href="https://joshuanrubin.com" target="_blank">Joshua Rubin</a>
            </div>
        </div>

        <div class="get-ready-display" style="display:none;">
            GET READY
        </div>

        <div class="row">
            <div class="stopwatch col-xs-12 text-center">
                <div id="stopwatch"></div>
            </div>
        </div>
        <br/>

        <div id="setTime" class="time-input-container">
            <div class="helptext">Set Timer</div>
            <input type="text" 
                   class="time-input" 
                   id="timeInput" 
                   placeholder="HH:MM:SS"
                   pattern="^-?\d{0,2}:[0-5]\d:[0-5]\d$"
                   title="Format: HH:MM:SS or -HH:MM:SS"/>
            <div class="time-input-error" id="timeInputError">Please enter a valid time format (HH:MM:SS)</div>
            <div class="time-presets">
                <div class="time-preset" data-time="00:05:00">5min</div>
                <div class="time-preset" data-time="00:10:00">10min</div>
                <div class="time-preset" data-time="00:15:00">15min</div>
                <div class="time-preset" data-time="00:30:00">30min</div>
                <div class="time-preset" data-time="-00:00:30">-30sec</div>
                <div class="time-preset" data-time="-00:01:00">-1min</div>
            </div>
        </div>

        <div class="helptext col-xs-12 text-center">
            <button class="btn btn-danger stopbutton" onclick="stopTimer();return false;">Stop</button>
            <button class="btn btn-success startbutton" onclick="startTimer();return false;">Start</button>
            <button id="getReadyBtn" class="btn btn-primary" onclick="toggleGetReady();return false;" data-active="false">Get Ready</button>
        </div>
        <br/><br/><br/><br/>

        <script type="text/javascript">
            //constantly looking at timecheck.
            var alwayscheck = false;
            var startTime = 0;
            
            function stopTimer() {
                $.ajax({
                    url:"timecheck.php",
                    type:"post",
                    data: {action:"startOrStopTimer", start:"0"},
                    success:function(results){
                        console.log(results);
                    }
                });
            }
            
            function formatTime(diffTime) {
                let isNegative = diffTime < 0;
                diffTime = Math.abs(diffTime);
                
                let h = new Date(diffTime).getUTCHours();
                let m = new Date(diffTime).getUTCMinutes();
                let s = new Date(diffTime).getUTCSeconds() % 60;
                
                // Convert to strings and pad with zeros
                h = h.toString().padStart(2, '0');
                m = m.toString().padStart(2, '0');
                s = s.toString().padStart(2, '0');
                
                // Add negative sign if needed
                return (isNegative ? '-' : '') + h + ':' + m + ':' + s;
            }

            function parseTimeInput(timeStr) {
                const regex = /^(-)?(\d{1,2}):([0-5]\d):([0-5]\d)$/;
                const match = timeStr.match(regex);
                
                if (!match) return null;
                
                const [, negative, hours, minutes, seconds] = match;
                const multiplier = negative ? -1 : 1;
                
                return {
                    hour: (parseInt(hours) * multiplier).toString(),
                    minute: (parseInt(minutes) * multiplier).toString(),
                    second: (parseInt(seconds) * multiplier).toString()
                };
            }

            function validateTimeInput() {
                const timeInput = document.getElementById('timeInput');
                const errorDiv = document.getElementById('timeInputError');
                const value = timeInput.value;
                
                if (!value) {
                    errorDiv.style.display = 'none';
                    return true;
                }
                
                const isValid = /^-?\d{1,2}:[0-5]\d:[0-5]\d$/.test(value);
                errorDiv.style.display = isValid ? 'none' : 'block';
                return isValid;
            }

            function startTimer() {
                if (!validateTimeInput()) return;
                
                const timeInput = document.getElementById('timeInput');
                const timeValues = parseTimeInput(timeInput.value || '00:00:00');
                
                if (!timeValues) {
                    document.getElementById('timeInputError').style.display = 'block';
                    return;
                }
                
                $.ajax({
                    url: "timecheck.php",
                    type: "post",
                    data: {
                        action: "startOrStopTimer",
                        start: "1",
                        hour: timeValues.hour,
                        minute: timeValues.minute,
                        second: timeValues.second
                    },
                    success: function(results) {
                        console.log('Timer start response:', results);
                    }
                });
            }
            
            function toggleGetReady() {
                var $getReadyBtn = $("#getReadyBtn");
                var currentStatus = $getReadyBtn.data('active') ? 1 : 0;
                
                $.ajax({
                    url: "timecheck.php",
                    type: "post",
                    data: {
                        action: "toggleGetReady", 
                        status: currentStatus ? 0 : 1
                    },
                    success: function(results) {
                        console.log(results);
                        if (!currentStatus) {
                            $getReadyBtn.data('active', true);
                            $getReadyBtn.text("Stop Get Ready");
                            $getReadyBtn.removeClass('btn-primary').addClass('btn-danger');
                        } else {
                            $getReadyBtn.data('active', false);
                            $getReadyBtn.text("Get Ready");
                            $getReadyBtn.removeClass('btn-danger').addClass('btn-primary');
                        }
                    }
                });
            }
            
            // Periodic check function
            alwayscheck = setInterval(function(){
                // Timer check
                $.ajax({
                    url: "timecheck.php",
                    type: "post",
                    data: {action: "checkTimer"},
                    success: function(results){
                        results = $.parseJSON(results);
                        $("#timer").html(results.curtime.toString());
                        
                        if(results.started == 1){
                            startTime = new Date(results.start_time * 1000).getTime();
                            curTime = new Date(results.unixtime * 1000).getTime();
                            diffTime = curTime - startTime;
                            
                            $("#stopwatch").html(formatTime(diffTime));
                        }
                        
                        if(results.started == 0){
                            startTime = 0;
                            $("#status").html("stopwatch off");
                        } else {
                            $("#status").html("ON!");
                        }
                    }
                });
                
                // Get Ready status check
                $.ajax({
                    url: "timecheck.php",
                    type: "post",
                    data: {action: "checkGetReady"},
                    success: function(results) {
                        results = $.parseJSON(results);
                        if (results.getReady == 1) {
                            $(".get-ready-display").show();
                        } else {
                            $(".get-ready-display").hide();
                        }
                    }
                });
            }, 100);

            // Add event listeners after document load
            document.addEventListener('DOMContentLoaded', function() {
                // Time input validation
                const timeInput = document.getElementById('timeInput');
                timeInput.addEventListener('input', validateTimeInput);
                
                // Time presets
                document.querySelectorAll('.time-preset').forEach(preset => {
                    preset.addEventListener('click', function() {
                        timeInput.value = this.dataset.time;
                        validateTimeInput();
                    });
                });
            });
        </script>
    </body>
</html>